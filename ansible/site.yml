- hosts: server
  become: yes
  roles:
    - base
    - wireguard

  vars:
    kubeconfig_path: /etc/rancher/k3s/k3s.yaml

  tasks:
    # Instal Pip for Python3
    - name: Ensure Python3 pip is installed
      apt:
        name: python3-pip
        state: present

    
    # Install Kubernetes Python module with --break-system-packages
    - name: Install Kubernetes Python module
      pip:
        name: kubernetes
        executable: pip3
        extra_args: --break-system-packages

    # Install Docker
    - name: Ensure Docker is installed
      apt:
        name: docker.io
        state: present

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    # Install k3s
    - name: Install k3s
      shell: |
        curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Ensure kubeconfig is readable
      file:
        path: "{{ kubeconfig_path }}"
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    # Deploy Kubernetes Deployment
    - name: Deploy Kubernetes resources
      kubernetes.core.k8s:
        state: present
        definition: "{{lookup('file', '../kube/deployment.yml') | from_yaml_all }}"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # Deploy Kubernetes Service
    - name: Deploy Service
      kubernetes.core.k8s:
        state: present
        definition: "{{lookup('file', '../kube/service.yml') | from_yaml_all }}"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

